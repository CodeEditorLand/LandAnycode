<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Mocha Tests</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
	</head>
	<body>
		<div id="mocha"></div>

		<script src="https://unpkg.com/chai/chai.js"></script>
		<script src="https://unpkg.com/mocha/mocha.js"></script>

		<script class="mocha-init">
			mocha.setup({
				ui: 'tdd',
				timeout: 1000
			});

			function serializeSuite(suite) {
				return {
					root: suite.root,
					suites: suite.suites.map(serializeSuite),
					tests: suite.tests.map(serializeRunnable),
					title: suite.title,
					fullTitle: suite.fullTitle(),
					titlePath: suite.titlePath(),
					timeout: suite.timeout(),
					retries: suite.retries(),
					slow: suite.slow(),
					bail: suite.bail()
				};
			}
			function serializeRunnable(runnable) {
				return {
					title: runnable.title,
					titlePath: runnable.titlePath(),
					fullTitle: runnable.fullTitle(),
					async: runnable.async,
					slow: runnable.slow(),
					speed: runnable.speed,
					duration: runnable.duration,
					currentRetry: runnable.currentRetry(),
				};
			}
			function serializeError(err) {
				return {
					message: err.message,
					stack: err.stack,
					actual: err.actual,
					expected: err.expected,
					uncaught: err.uncaught,
					showDiff: err.showDiff,
					inspect: typeof err.inspect === 'function' ? err.inspect() : ''
				};
			}

			function PlaywrightReporter(runner) {
				runner.on('start', () => window.mocha_report('start'));
				runner.on('end', () => window.mocha_report('end'));
				runner.on('suite', suite => window.mocha_report('suite', serializeSuite(suite)));
				runner.on('suite end', suite => window.mocha_report('suite end', serializeSuite(suite)));
				runner.on('test', test => window.mocha_report('test', serializeRunnable(test)));
				runner.on('test end', test => window.mocha_report('test end', serializeRunnable(test)));
				runner.on('hook', hook => window.mocha_report('hook', serializeRunnable(hook)));
				runner.on('hook end', hook => window.mocha_report('hook end', serializeRunnable(hook)));
				runner.on('pass', test => window.mocha_report('pass', serializeRunnable(test)));
				runner.on('fail', (test, err) => window.mocha_report('fail', serializeRunnable(test), serializeError(err)));
				runner.on('pending', test => window.mocha_report('pending', serializeRunnable(test)));
			}


		</script>
		<script src="./all.test.js"></script>
		<script class="mocha-exec">
			window.mocha_run = () => {
				const _debug = new URL(window.location.href).searchParams.has('debug')
				if(!_debug) {
					mocha.reporter(PlaywrightReporter)
				}
				return new Promise(resolve => {
					mocha.run(failCount => resolve(failCount));
				})
			}
		</script>
	</body>
</html>
